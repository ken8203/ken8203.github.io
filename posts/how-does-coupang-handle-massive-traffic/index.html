<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>How Does Coupang Handle Massive Traffic &#183; Hi im jaychung</title><link rel=stylesheet href=https://blog.jaychung.tw/css/slim.css><link rel=stylesheet href=https://blog.jaychung.tw/css/highlight.min.css><link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Source+Code+Pro" rel=stylesheet type=text/css><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.ico></head><body><div class=container><div class=header><h1 class=site-title><a href=https://blog.jaychung.tw/>Hi im jaychung</a></h1><p class=site-tagline></p><div class=nav><a class=nav-btn href=#><span class="ci ci-burger"></span></a><ul class=nav-list><li class=spacer>&ac;</li><li><a href=https://github.com/ken8203>Github</a></li><li><a href=https://twitter.com/jaychungtw>Twitter</a></li></ul></div></div><div class=content><div class=post><h2 class=post-title><a href=https://blog.jaychung.tw/posts/how-does-coupang-handle-massive-traffic/>How Does Coupang Handle Massive Traffic</a></h2><div class=post-content><p>My read notes of Coupang blog series.</p><h1 id=coupang>Coupang</h1><ul><li>A South Korean e-commerce company based in Seoul, South Korea, and incorporated in Delaware, United States.</li><li>Expanded to become the largest online marketplace in South Korea, and referred to as the &ldquo;Amazon of South Korea&rdquo;.</li><li>18M customers.</li></ul><h1 id=our-backend-strategy-to-handle-massive-traffic>Our backend strategy to handle massive traffic</h1><p>If all of Coupang application’s pages each directly called data from the microservices, the microservices would always have to secure high availability, and commonly used business logic code would be duplicated on the frontend without centralized management.</p><h2 id=core-serving-layer>Core serving layer</h2><p><img src=https://miro.medium.com/max/1400/1*_6gUj8_YN7xUn6NCrg0-Dw.jpeg alt></p><ul><li>Ensure HA (99.99%).</li><li>Serve data with high throughput & low latency.</li><li>Ensure consistency and freshness of data aggregated from various sources in real time.</li><li>Unify business logic code to reduce complexity and code redundancy on the frontend.</li></ul><h2 id=database-layer-nosql>Database layer (NoSQL)</h2><p><img src=https://miro.medium.com/max/1400/1*7-wES84odAmEzMqEQjsNNA.png alt></p><ul><li>Product domain information is managed by separate microservices in the backend.<ul><li>Images and titles are provided by the Catalog Team</li><li>Prices by the Pricing Team</li><li>Stock information by the Fulfillment Team</li></ul></li><li>Each microservice in the backend sends the updated data to the queue and saves it to the common storage.</li><li>The NoSQL database allows us to leverage eventual consistency and fetch data from all microservices in a single read.</li></ul><h2 id=read-through-cache-layer>Read-through cache layer</h2><p><img src=https://miro.medium.com/max/1400/1*pa7RktWnI_MFLLTF_NaM2w.jpeg alt></p><ul><li>Serve data with ten times higher throughput and three times less latency compared to the common storage.</li></ul><h2 id=real-time-cache-layer>Real-time cache layer</h2><p><img src=https://miro.medium.com/max/1400/1*XKjKl2l5Kth__s2i1dmzHg.jpeg alt></p><ul><li>The read-through cache layer provides minutes latency, but some data needs to be updated in a matter of seconds, e.g. stock information.</li></ul><h2 id=scale-of-two-cache-layers>Scale of two cache layers</h2><ul><li>Each layer is composed of 60 ~ 100 nodes.</li><li>Process up to 100M RPS.</li><li>95% of the incoming traffic is processed by the cache layers instead of the common storage layer.</li></ul><h2 id=high-availability-strategies>High availability strategies</h2><p><img src=https://miro.medium.com/max/1400/1*_uPKPp4U6Qkf0ktnf16REw.jpeg alt></p><ul><li>CSP a.k.a. critical serving path</li><li>N-CSP a.k.a. non critical serving path</li></ul><h2 id=core-serving-layer-template>Core serving layer template</h2><p><img src=https://miro.medium.com/max/1400/1*EcZpTBroaC5zgMI-JXkRgQ.jpeg alt></p><h1 id=lessons-learned-from-handling-massive-traffic-with-cache>Lessons learned from handling massive traffic with cache</h1><h2 id=lesson-1-managing-partial-cache-node-failure>Lesson 1: Managing partial cache node failure</h2><p><img src=https://miro.medium.com/max/1248/1*7UhT2thjukXCLzV9SP3kBw.jpeg alt></p><ul><li>In addition to monitoring topology refresh, we decided to monitor TCP connection speeds.</li><li>Connections without responses for one second were marked problematic and the connections to that node are automatically closed.</li></ul><p><img src=https://miro.medium.com/max/1248/1*afFVS3Sl-CNGnLXCnGBOvw.jpeg alt></p><h2 id=lesson-2-quickly-recovering-failed-nodes>Lesson 2: Quickly recovering failed nodes</h2><ul><li>When a node fails, it must go through a full sync process for recovery.</li><li>The incoming traffic to the cache layer was higher than the amount of traffic the buffer could handle.</li><li>They experienced frequent failures during the full sync and node recovery process.</li></ul><h3 id=finding-the-root-cause>Finding the root cause</h3><p><img src=https://miro.medium.com/max/1248/1*5vHxSKhhodjP1nen21onaQ.jpeg alt></p><h3 id=blocking-traffic-to-defective-replicas>Blocking traffic to defective replicas</h3><p><img src=https://miro.medium.com/max/1400/1*Qhtq1SPpBVBd233eU5tGJQ.png alt></p><h2 id=lesson-3-balancing-traffic-between-nodes>Lesson 3: Balancing traffic between nodes</h2><p><img src=https://miro.medium.com/max/832/1*xjCXnBYCp2vVwDkwQjukzg.jpeg alt></p><ul><li>Route randomly instead of route according to connection time.</li></ul><h2 id=lesson-4-handling-traffic-spikes-using-local-cache>Lesson 4: Handling traffic spikes using local cache</h2><ul><li>Although growing user traffic is good news for business, it may not always be welcomed by server engineers.</li><li>During COVID-19, we frequently saw unexpected spikes in traffic.</li><li>They had no choice but to secure <strong>three times</strong> the recommended server capacity for application stability.</li></ul><h3 id=traffic-analysis>Traffic analysis</h3><ul><li>Store the incoming requests to the message queue and used MapReduce to analyze user and product information of the requests on a minute basis.</li><li>The analysis revealed that most traffic spikes during COVID-19 were related to face mask restocks.</li></ul><h3 id=local-cache>Local cache</h3><p><img src=https://miro.medium.com/max/1400/1*TaR0YUECmRCuFF1pVyMahQ.jpeg alt></p><ul><li>Challenges<ul><li>Cache invalidation</li><li>GC counts and times</li></ul></li><li>Cache data that could be updated with eventual consistency, not strong consistency in only one minute.</li><li>Save data in a byte array format instead of the DTO(Data Transfer Object) format</li></ul><h3 id=non-blocking-io>Non-blocking I/O</h3><ul><li>With this change, we reduced CPU usage by more than 50% and used NIO threads to minimize CPU overhead.</li></ul><h1 id=references>References</h1><ul><li><a href=https://medium.com/coupang-engineering/our-backend-strategy-to-handle-massive-traffic-d30cd6cc4fb2>https://medium.com/coupang-engineering/our-backend-strategy-to-handle-massive-traffic-d30cd6cc4fb2</a></li><li><a href=https://medium.com/coupang-engineering/lessons-learned-from-operating-our-data-serving-layer-4e9e4f68fe85>https://medium.com/coupang-engineering/lessons-learned-from-operating-our-data-serving-layer-4e9e4f68fe85</a></li></ul></div></div></div><div class=footer><p>Copyright © 2020. Powered by Hugo.</p></div></div><script src=https://blog.jaychung.tw/js/slim.js></script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-56558534-1','auto');ga('send','pageview');</script></body></html>